<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit $name$</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/3party/fa/css/all.css">
    <link rel="stylesheet" href="/static/3party/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/3party/datatable.css">
    <link rel="stylesheet" href="/static/3party/datatable_bootstrap.css">

    <style>
        #elements {
            height: 100%;
            background: linear-gradient(#444 1px, transparent 1px) 0% 0% / 32px 32px repeat;
        }
        #container {
            position: absolute;
            top: 70%;
            left: 0px;
            right: 300px;
            height: 30%;
            background-color: #555;
        }
        #timeline {
            position: absolute;
            top: 0px;
            bottom: 0px;
            width: 100%;
            overflow: hidden;
        }
        #canvas {
            height: 32;
            position: absolute;
        }
        #scroller {
            position: absolute;
            top: 32px;
            bottom: 0px;
            width: 100%;
            overflow: auto;
        }

        #timeline .block {
            position: absolute;
            height: 30px;

            background-color: #88f;
            border-left: 1px solid #aaf;
            border-top: 1px solid #aaf;
            border-right: 1px solid #77f;
            border-bottom: 1px solid #77f;

            overflow: hidden;
            user-select: none;
        }

        #timeline .block:hover {
            background-color: #99f;
        }

        #timeline .block .name {
            font-family: Arial, sans-serif;
            font-size: 14px;

            margin: 7px 10px;
            color: rgba(0,0,0,0.5);
            cursor: default;
            white-space: nowrap;
        }

        #timeline .resize-left {
            position: absolute;
            width: 6px;
            height: 30px;
            cursor: w-resize;
        }
        #timeline .resize-right {
            position: absolute;
            width: 6px;
            height: 30px;
            cursor: e-resize;

            right: 0px;
            top: 0px;
        }
    </style>
</head>
<body>

<!--<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Create SetValueKey Frame</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <select class="form-control" name="add">
                    $@devices$
                    <option>$name$</option>
                    $@@$
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>-->
<div id="container">
    <div id="timeline">
        <canvas id="canvas"></canvas>
        <div id="scroller">
            <div id="elements"></div>
        </div>
    </div>
</div>

<script src="/static/3party/jquery.js"></script>
<script src="/static/3party/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/3party/datatables.js"></script>
<script src="/static/3party/datatable_bootstrap.js"></script>

<script>
    var animations = [];
    var selected;

    function select(animation) {
        console.log("Selected " + animation.name);
        selected = animation;
    }

    class Animation {
        constructor(name, start, end, layer) {
            this.name = name;
            this.start = start;
            this.end = end;
            this.layer = layer;

            this.dom = document.createElement("div");
            var dom = this.dom;
            dom.className = 'block';

            var scope = this;

            dom.addEventListener('click', function (event) {
                select(scope);
            });

            dom.addEventListener('mousedown', function (event) {
                var movementX = 0;
                var movementY = 0;

                function onMouseMove(event) {
                    //debugger;
                    
                    movementX = event.movementX;
                    scope.start += movementX / scale;
                    scope.end += movementX / scale;
                    if (scope.start < 0) {
                        var offset = -scope.start;
                        scope.start += offset;
                        scope.end += offset;
                    }

                    movementY += event.movementY;
                    if (movementY >= 30) {
                        scope.layer = scope.layer + 1;
                        movementY = 0;
                    }
                    if (movementY <= -30) {
                        scope.layer = Math.max(0, scope.layer - 1);
                        movementY = 0;
                    }
                    update();
                }

                function onMouseUp(event) {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove, false);
                document.addEventListener('mouseup', onMouseUp, false);
            }, false);

            var resizeLeft = document.createElement('div');
            resizeLeft.className = 'resize-left';
            resizeLeft.addEventListener('mousedown', function (event) {
                //debugger;
                event.stopPropagation();

                var movementX = 0;
                function onMouseMove(event) {
                    movementX = event.movementX;
                    scope.start += movementX / scale;
                    update();
                }

                function onMouseUp(event) {
                    if (Math.abs(movementX) < 2) {
                        select(scope);   
                    }
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove, false);
                document.addEventListener('mouseup', onMouseUp, false);
            }, false);
            dom.appendChild(resizeLeft);

            var name = document.createElement('div');
            this.nameDom = name;
            name.className = 'name';
            dom.appendChild(name);

            var resizeRight = document.createElement( 'div' );
            resizeRight.className = 'resize-right';
            resizeRight.addEventListener('mousedown', function (event) {
                //debugger;
                event.stopPropagation();

                var movementX = 0;
                function onMouseMove(event) {
                    movementX = event.movementX;
                    scope.end += movementX / scale;
                    update();
                }

                function onMouseUp(event) {
                    if (Math.abs(movementX) < 2) {
                        select(scope)
                    }
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove, false);
                document.addEventListener('mouseup', onMouseUp, false);

            }, false);
            dom.appendChild(resizeRight);
        }

        update() {
            this.dom.style.left = (this.start * scale) + 'px';
			this.dom.style.top = (this.layer * 32) + 'px';
			this.dom.style.width = ((this.end - this.start) * scale - 2) + 'px';

			this.nameDom.innerHTML = this.name + ' <span style="opacity:0.5">Effect</span>';
        }
    }

    function addAnimation(animation) {
        console.log("Animation added");
        animations.push(animation);
        elementsDom.appendChild(animation.dom);
        animation.update();
    }

    var duration = 120;
    var scale = 32;
    var canvas = $("#canvas").get(0);
    var timeline = $("#timeline");
    var scroller = $("#scroller");
    var elements = $("#elements");
    var elementsDom = elements.get(0);

    function update() {
        canvas.width = scroller.get(0).clientWidth;
        var context = canvas.getContext( '2d', { alpha: false });

		context.fillStyle = '#555';
		context.fillRect( 0, 0, canvas.width, canvas.height);

		context.strokeStyle = '#888';
		context.beginPath();

		context.translate(-scroller.scrollLeft(), 0);
		var width = duration * scale;
		var scale4 = scale / 4;

		for (var i = 0.5; i <= width; i += scale) {
			context.moveTo(i + (scale4 * 0), 18); context.lineTo(i + (scale4 * 0), 26);

			if (scale > 16) context.moveTo(i + (scale4 * 1), 22), context.lineTo(i + (scale4 * 1), 26);
			if (scale >  8) context.moveTo(i + (scale4 * 2), 22), context.lineTo(i + (scale4 * 2), 26);
			if (scale > 16) context.moveTo(i + (scale4 * 3), 22), context.lineTo(i + (scale4 * 3), 26);
		}

		context.stroke();

		context.font = '10px Arial';
		context.fillStyle = '#888'
		context.textAlign = 'center';

		var step = Math.max(1, Math.floor(64 / scale));
		for (var i = 0; i < duration; i += step) {
			var minute = Math.floor(i / 60);
			var second = Math.floor(i % 60);

			var text = (minute > 0 ? minute + ':' : '') + ('0' + second).slice(-2);

			context.fillText(text, i * scale, 13);

		}
        elements.width(duration * scale);

        animations.forEach(function(animation) {
            animation.update();
        });
    }
    $(document).ready(function() {
        timeline.on('wheel', function(event) {
            if (event.altKey) {
                event.preventDefault();
                var oldScale = scale;
                scale = Math.max(2, scale + (event.originalEvent.deltaY / 10));
                scroller.scrollLeft((scroller.scrollLeft() * scale) / oldScale);
                console.log("Scaled from " + oldScale + " to " + scale);
                update();
            }
        });
        elements.on('dblclick', function() {
            var start = event.offsetX / scale;
            var end = start + 2;
            var layer = Math.floor(event.offsetY / 32);

            var animation = new Animation("Animation", start, end, layer);
            //debugger;
            addAnimation(animation);
        });
        scroller.scroll(function() {
            update();
        });
        window.addEventListener('resize', function() {
            console.log("resize")
            update();
        });
        update();
    });
</script>

</body>
</html>